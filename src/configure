#!/bin/bash

# read openhab config
. $SNAP/bin/config

# settings were altered by user, safest way to get them applied is to restart service

# TODO: remove this workaround once it's not needed
# for the moment we can't read settings outside of the hook,
# so store all settings in helpper script which is then picked by main wrapper
echo -e "#!/bin/sh\n" > $SETTINGS_FILE
for key in ${keys[@]}
do
  if value=$(snapctl get $key); then
      echo "export $key='$value'" >> $SETTINGS_FILE
  elif [ -d "${!key}" ]; then
      # store back value from SETTINGS_FILE
      echo "export $key='${!key}'" >> $SETTINGS_FILE
  fi
done

# set file executable
chmod 755 $SETTINGS_FILE

# we can't use snapctl to restart service, may be one day ....
echo "Setting has been updated, restart service. $ sudo openhab.stop"

# configure hook can be also run as part of update, migrate data if needed here, use
# version key to track state

VERSION=$(snapctl get version)
snapctl set version $SNAP_VERSION

# copy over data from snap if needed
# conf
if [ ! -d $SNAP_COMMON/conf ]; then
    cp -rf $SNAP/conf $SNAP_COMMON/
fi

# check if we have userdata, if not this is new install
if [ -d $SNAP_COMMON/userdata ]; then
    VERSION=$(snapctl get version)
    if [ "$VERSION" != "$SNAP_VERSION" ]; then
        cp -r -n $SNAP/userdata/etc $SNAP_COMMON/userdata/
        cp -r -n $SNAP/conf $SNAP_COMMON/
        rm -rf $SNAP_COMMON/userdata/cache
        rm -rf $SNAP_COMMON/userdata/tmp
        snapctl set version $SNAP_VERSION
    fi
else
    cp -rf $SNAP/userdata $SNAP_COMMON/
    cp -rf $SNAP/conf $SNAP_COMMON/
    snapctl set version $SNAP_VERSION
fi
